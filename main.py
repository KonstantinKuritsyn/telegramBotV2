from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, PicklePersistence
import random
import datetime
import pytz
import os

moscow_tz = pytz.timezone('Europe/Moscow')

wishes = [
    "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –ø—Ä–∏–Ω–µ—Å—ë—Ç —Ç–µ–±–µ —Ä–∞–¥–æ—Å—Ç—å –∏ —É–¥–∞—á—É!",
    "–ñ–µ–ª–∞—é –æ—Ç–ª–∏—á–Ω–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å!",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë –ø–æ–ª—É—á–∏—Ç—Å—è —Ç–∞–∫, –∫–∞–∫ —Ç—ã –∑–∞–¥—É–º–∞–ª!",
    "–£–ª—ã–±–∞–π—Å—è —á–∞—â–µ ‚Äî —ç—Ç–æ —É–∫—Ä–∞—à–∞–µ—Ç —Ç–≤–æ–π –¥–µ–Ω—å!",
    "–ñ–µ–ª–∞—é –∫—Ä–µ–ø–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è –∏ –º–Ω–æ–≥–æ –ø—Ä–∏—è—Ç–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤!",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –ø–æ–≤–æ–¥ –¥–ª—è –≥–æ—Ä–¥–æ—Å—Ç–∏ —Å–æ–±–æ–π!",
    "–ñ–µ–ª–∞—é –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–æ–±—Ä—ã—Ö –∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏—Ö –ª—é–¥–µ–π!",
    "–ü—É—Å—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å —ç—Ç–æ–≥–æ –¥–Ω—è –±—É–¥–µ—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω —Å—á–∞—Å—Ç—å–µ–º!",
    "–ü—É—Å—Ç—å —É–¥–∞—á–∞ —Å–æ–ø—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–±–µ –≤–æ –≤—Å–µ—Ö –¥–µ–ª–∞—Ö!",
    "–ñ–µ–ª–∞—é –≥–∞—Ä–º–æ–Ω–∏–∏, —Ç–µ–ø–ª–∞ –∏ —É—é—Ç–∞ –≤ –¥—É—à–µ!",
    "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç —Å–≤–µ—Ç–ª—ã–º –∏ —Ä–∞–¥–æ—Å—Ç–Ω—ã–º!",
    "–ñ–µ–ª–∞—é –Ω–∞–π—Ç–∏ –≤—Ä–µ–º—è –¥–ª—è —Å–µ–±—è –∏ —Å–≤–æ–∏—Ö —É–≤–ª–µ—á–µ–Ω–∏–π!",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è —Å–±—É–¥–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ç–≤–æ–µ –∂–µ–ª–∞–Ω–∏–µ!",
    "–ñ–µ–ª–∞—é –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –∏ —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö —É—Å–ø–µ—Ö–æ–≤!",
    "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –ø—Ä–∏–Ω–µ—Å—ë—Ç —Ç–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏!",
    "–ñ–µ–ª–∞—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Å–≤–æ–∏—Ö —Å–∏–ª–∞—Ö –∏ –ø–æ–±–µ–¥!",
    "–ü—É—Å—Ç—å —Ä—è–¥–æ–º –±—É–¥—É—Ç —Ç–æ–ª—å–∫–æ –≤–µ—Ä–Ω—ã–µ –¥—Ä—É–∑—å—è!",
    "–ñ–µ–ª–∞—é –º–∏—Ä–∞ –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è –≤ –¥—É—à–µ!",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –ø–æ–≤–æ–¥ –¥–ª—è —É–ª—ã–±–∫–∏!",
    "–ñ–µ–ª–∞—é —Ç–µ–±–µ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ —Å—á–∞—Å—Ç—å—è —Å–µ–≥–æ–¥–Ω—è –∏ –≤—Å–µ–≥–¥–∞!",
    "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –ø—Ä–∏–Ω–µ—Å—ë—Ç —Ç–µ–±–µ —Ç–æ–ª—å–∫–æ —Ä–∞–¥–æ—Å—Ç—å –∏ —É–ª—ã–±–∫–∏!",
    "–ñ–µ–ª–∞—é —Ç–µ–±–µ –ª—ë–≥–∫–æ—Å—Ç–∏ –≤–æ –≤—Å–µ—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏—è—Ö!",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –Ω–∞–∏–ª—É—á—à–∏–º –æ–±—Ä–∞–∑–æ–º!",
    "–ñ–µ–ª–∞—é, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç –±—ã–ª –Ω–∞–ø–æ–ª–Ω–µ–Ω —Å—á–∞—Å—Ç—å–µ–º!",
    "–ü—É—Å—Ç—å —É–¥–∞—á–∞ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç —Ç–µ–±—è –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥—É!",
    "–ñ–µ–ª–∞—é –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –∏ —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö —É—Å–ø–µ—Ö–æ–≤!",
    "–ü—É—Å—Ç—å —Ä—è–¥–æ–º –±—É–¥—É—Ç —Ç–æ–ª—å–∫–æ –¥–æ–±—Ä—ã–µ –∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–µ –ª—é–¥–∏!",
    "–ñ–µ–ª–∞—é –≥–∞—Ä–º–æ–Ω–∏–∏ –≤ –¥—É—à–µ –∏ –ø–æ–∫–æ—è –≤ —Å–µ—Ä–¥—Ü–µ!",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è —Å–±—É–¥–µ—Ç—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Ç–≤–æ—è –º–µ—á—Ç–∞!",
    "–ñ–µ–ª–∞—é —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Å–≤–æ–∏—Ö —Å–∏–ª–∞—Ö –∏ –≤–µ—Ä—ã –≤ —Å–µ–±—è!",
    "–ü—É—Å—Ç—å –¥–µ–Ω—å –±—É–¥–µ—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω –ø—Ä–∏—è—Ç–Ω—ã–º–∏ —Å—é—Ä–ø—Ä–∏–∑–∞–º–∏!",
    "–ñ–µ–ª–∞—é –∫—Ä–µ–ø–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è –∏ –±–æ–¥—Ä–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!",
    "–ü—É—Å—Ç—å –∫–∞–∂–¥—ã–π —á–∞—Å —ç—Ç–æ–≥–æ –¥–Ω—è –±—É–¥–µ—Ç –æ—Å–æ–±–µ–Ω–Ω—ã–º!",
    "–ñ–µ–ª–∞—é –Ω–∞–π—Ç–∏ –ø–æ–≤–æ–¥ –¥–ª—è —Ä–∞–¥–æ—Å—Ç–∏ –¥–∞–∂–µ –≤ –º–µ–ª–æ—á–∞—Ö!",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –º–Ω–æ–≥–æ –ø—Ä–∏—è—Ç–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á –∏ —Å–æ–±—ã—Ç–∏–π!",
    "–ñ–µ–ª–∞—é —Ç–µ–±–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≥–∞—Ä–º–æ–Ω–∏–∏ –∏ —Ç–µ–ø–ª–∞!",
    "–ü—É—Å—Ç—å –≤—Å—ë –∑–∞–¥—É–º–∞–Ω–Ω–æ–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç—Å—è!",
    "–ñ–µ–ª–∞—é, —á—Ç–æ–±—ã –¥–µ–Ω—å –ø—Ä–æ—à—ë–ª –ª–µ–≥–∫–æ –∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ!",
    "–ü—É—Å—Ç—å —Ç–≤–æ—è —É–ª—ã–±–∫–∞ –æ–∑–∞—Ä—è–µ—Ç —ç—Ç–æ—Ç –¥–µ–Ω—å!",
    "–ñ–µ–ª–∞—é –º–æ—Ä–µ –ø–æ–∑–∏—Ç–∏–≤–∞ –∏ —Ö–æ—Ä–æ—à–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è!",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –¥–µ–Ω—å –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π!",
    "–ñ–µ–ª–∞—é —Ç–µ–±–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ –±—É–¥—É—â–µ–º!",
    "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –ø–æ–¥–∞—Ä–∏—Ç –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–≤–µ—Ä—à–µ–Ω–∏–π!",
    "–ñ–µ–ª–∞—é –ø—Ä–∏—è—Ç–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç–∏–π –∏ —Ä–∞–¥–æ—Å—Ç–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π!",
    "–ü—É—Å—Ç—å –∫–∞–∂–¥—ã–π –º–∏–≥ –±—É–¥–µ—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω –ª—é–±–æ–≤—å—é –∏ –∑–∞–±–æ—Ç–æ–π!",
    "–ñ–µ–ª–∞—é —Ç–µ–±–µ –≥–∞—Ä–º–æ–Ω–∏–∏ —Å —Å–æ–±–æ–π –∏ –æ–∫—Ä—É–∂–∞—é—â–∏–º –º–∏—Ä–æ–º!",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –±–æ–ª—å—à–µ –ø–æ–≤–æ–¥–æ–≤ –¥–ª—è —Å—á–∞—Å—Ç—å—è!",
    "–ñ–µ–ª–∞—é, —á—Ç–æ–±—ã –¥–µ–Ω—å –ø—Ä–æ—à—ë–ª –ª–µ–≥–∫–æ –∏ –±–µ–∑ –∑–∞–±–æ—Ç!",
    "–ü—É—Å—Ç—å —É–¥–∞—á–∞ –±—É–¥–µ—Ç —Ç–≤–æ–∏–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º —Å–ø—É—Ç–Ω–∏–∫–æ–º!",
    "–ñ–µ–ª–∞—é, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π —Ç–≤–æ–π —à–∞–≥ –≤—ë–ª –∫ —É—Å–ø–µ—Ö—É!"
]

flowers = [
    "üå∏",  # –¶–≤–µ—Ç–æ–∫ —Å–∞–∫—É—Ä—ã
    "üå∑",  # –¢—é–ª—å–ø–∞–Ω
    "üåπ",  # –†–æ–∑–∞
    "üå∫",  # –ì–∏–±–∏—Å–∫—É—Å
    "üåª",  # –ü–æ–¥—Å–æ–ª–Ω—É—Ö
    "üåº",  # –†–æ–º–∞—à–∫–∞
    "üåø",  # –í–µ—Ç–∫–∞
    "üçÄ",  # –ö–ª–µ–≤–µ—Ä
    "üçÅ",  # –ö–ª–µ–Ω–æ–≤—ã–π –ª–∏—Å—Ç
    "üçÇ",  # –û—Å–µ–Ω–Ω–∏–π –ª–∏—Å—Ç
    "üçÉ",  # –õ–∏—Å—Ç
    "üçÑ",  # –ì—Ä–∏–±
    "üíê",  # –ë—É–∫–µ—Ç
]


async def send_daily_color(context: ContextTypes.DEFAULT_TYPE):
    chat_id = context.job.chat_id
    wish = random.choice(wishes)
    flower = random.choice(flowers)
    await context.bot.send_message(chat_id=chat_id, text=f"{wish} {flower}")


async def start(update, context):
    chat_id = update.effective_chat.id
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –Ø –±—É–¥—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø–∏—Å–∞—Ç—å —Ç–µ–±–µ –ø—Ä–∏—è—Ç–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è")
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º chat_id –≤ chat_data
    context.application.chat_data[chat_id]['subscribed'] = True
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    remove_job_if_exists(str(chat_id), context)
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –∑–∞–¥–∞—á—É
    time_to_send = datetime.time(hour=19, minute=20, tzinfo=moscow_tz)
    context.job_queue.run_daily(send_daily_color, time=time_to_send, chat_id=chat_id, name=str(chat_id))
    await update.message.reply_text("–ù–∞—á–∏–Ω–∞—é –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏—è")


async def restore_jobs(app):
    for chat_id, data in app.chat_data.items():
        if data.get('subscribed'):
            time_to_send = datetime.time(hour=19, minute=20, tzinfo=moscow_tz)
            app.job_queue.run_daily(
                send_daily_color,
                time=time_to_send,
                chat_id=chat_id,
                name=str(chat_id)
            )


def remove_job_if_exists(name: str, context):
    current_jobs = context.job_queue.get_jobs_by_name(name)
    if not current_jobs:
        return False
    for job in current_jobs:
        job.schedule_removal()
    return True


async def stop(update, context):
    chat_id = update.effective_chat.id
    removed = remove_job_if_exists(str(chat_id), context)
    context.chat_data['subscribed'] = False
    if removed:
        await update.message.reply_text("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.")
    else:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ –±—ã–ª–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á.")


if __name__ == '__main__':
    persistence = PicklePersistence(filepath='bot_data')
    app = ApplicationBuilder().token(os.environ.get('TELEGRAM_TOKEN')).persistence(persistence).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("stop", stop))
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")

    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
    app.post_init = restore_jobs

    app.run_polling()
